{% import 'macros/relativeDate' as macro %}

{% set coursesParentId = 40 %}

{# Select the course that is happening right now #}
{% set currentCourse = craft.entries.descendantOf(coursesParentId).type('courseDetail').order('courseStartDate DESC').courseStartDate('<=' ~ now).courseEndDate('>=' ~ now).limit(1).first %}

{# Check which courseDate will be the next to take place #}
{% set courseAgendaUrl = currentCourse.courseAgenda|length ? currentCourse.courseAgenda.first.url %}
{% set courseDates = currentCourse.courseDates.order('timeFrameStart') %}
{% set nextLectureModel = false %}
{% set nextCourseDate = null %}

{# Set today without the time, to compare days only #}
{% set dayFormat = 'Y-m-d' %}
{% set today = now|date(dayFormat) %}

{# Iterate over each courseDate that has not yet ended #}
{% for date in courseDates if date(date.timeFrameEnd|date(dayFormat)) >= date(today) %}

    {# Only store the first (and therefore next) date #}
    {% if nextLectureModel == false %}
        {% set nextLectureModel = date %}
    {% endif %}

{% endfor %}

{% if nextLectureModel != false %}
    {% set nextCourseDate = {start: nextLectureModel.timeFrameStart, end: nextLectureModel.timeFrameEnd} %}
{% endif %}

{% include 'matrix/mosaicTiles/courseEntry' with {
    courseModel: currentCourse,
    subtitle: defaultStringNextLecture.label,
    courseDate: nextCourseDate is defined ? nextCourseDate,
    buttonLabel: courseAgendaUrl ? 'Wochenplan herunterladen',
    buttonTarget: courseAgendaUrl ? courseAgendaUrl,
    buttonClassAppend: courseAgendaUrl ? '_pdf'
} %}
